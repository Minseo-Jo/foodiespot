<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>개인분석 - 맛집 추천 서비스</title>
    <link rel="stylesheet" href="common.css">
    <style>
        body {
            padding-bottom: 80px;
            background: var(--gray-50);
        }

        .profile-header {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-dark));
            color: white;
            padding: var(--space-8) var(--space-4);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .profile-header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(30px, -30px);
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: var(--radius-full);
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin: 0 auto var(--space-4);
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .profile-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: var(--space-1);
        }

        .profile-stats {
            display: flex;
            justify-content: center;
            gap: var(--space-6);
            opacity: 0.9;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 18px;
            font-weight: 700;
            display: block;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
        }

        .dashboard-section {
            margin: var(--space-6) 0;
            padding: 0 var(--space-4);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .section-action {
            color: var(--primary-blue);
            font-size: 12px;
            text-decoration: none;
            font-weight: 500;
        }

        /* 가성비 기준 차트 */
        .value-criteria-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-4);
        }

        .radar-chart {
            width: 200px;
            height: 200px;
            margin: 0 auto var(--space-4);
            position: relative;
            background: conic-gradient(
                from 0deg,
                var(--primary-blue-light) 0deg 90deg,
                var(--food-orange-light) 90deg 180deg,
                var(--success-green) 180deg 270deg,
                var(--warning-yellow) 270deg 360deg
            );
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .radar-chart::before {
            content: '';
            width: 120px;
            height: 120px;
            background: var(--white);
            border-radius: var(--radius-full);
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .radar-center {
            position: relative;
            z-index: 1;
            text-align: center;
        }

        .overall-score {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-blue);
            display: block;
        }

        .score-label {
            font-size: 12px;
            color: var(--gray-500);
        }

        .factor-legends {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-4);
        }

        .factor-legend {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .factor-color {
            width: 12px;
            height: 12px;
            border-radius: var(--radius-sm);
        }

        .factor-color.price { background: var(--primary-blue-light); }
        .factor-color.portion { background: var(--food-orange-light); }
        .factor-color.taste { background: var(--success-green); }
        .factor-color.service { background: var(--warning-yellow); }

        .factor-text {
            font-size: 12px;
            color: var(--gray-700);
            font-weight: 500;
        }

        .factor-score {
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-900);
            margin-left: auto;
        }

        /* 최근 평가 */
        .recent-evaluations {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }

        .evaluation-item {
            padding: var(--space-4);
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            gap: var(--space-3);
        }

        .evaluation-item:last-child {
            border-bottom: none;
        }

        .evaluation-image {
            width: 50px;
            height: 50px;
            border-radius: var(--radius-md);
            object-fit: cover;
            flex-shrink: 0;
        }

        .evaluation-content {
            flex: 1;
        }

        .evaluation-restaurant {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: var(--space-1);
        }

        .evaluation-date {
            font-size: 11px;
            color: var(--gray-500);
            margin-bottom: var(--space-2);
        }

        .evaluation-scores {
            display: flex;
            gap: var(--space-2);
        }

        .score-badge {
            background: var(--gray-100);
            color: var(--gray-700);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            font-size: 10px;
            font-weight: 500;
        }

        .score-badge.excellent {
            background: var(--success-green);
            color: white;
        }

        .score-badge.good {
            background: var(--primary-blue);
            color: white;
        }

        /* 성과 배지 */
        .achievements {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            box-shadow: var(--shadow-md);
        }

        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: var(--space-4);
            margin-top: var(--space-4);
        }

        .achievement-item {
            text-align: center;
            padding: var(--space-3);
            border-radius: var(--radius-lg);
            background: var(--gray-50);
            transition: all 0.2s ease;
        }

        .achievement-item.unlocked {
            background: var(--primary-blue-light);
        }

        .achievement-icon {
            font-size: 24px;
            margin-bottom: var(--space-1);
        }

        .achievement-name {
            font-size: 10px;
            font-weight: 500;
            color: var(--gray-700);
        }

        .achievement-item.unlocked .achievement-name {
            color: var(--primary-blue-dark);
            font-weight: 600;
        }

        /* 추천 정확도 */
        .accuracy-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            box-shadow: var(--shadow-md);
            text-align: center;
        }

        .accuracy-circle {
            width: 120px;
            height: 120px;
            border-radius: var(--radius-full);
            background: conic-gradient(var(--success-green) 0deg 288deg, var(--gray-200) 288deg 360deg);
            margin: 0 auto var(--space-4);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .accuracy-circle::before {
            content: '';
            width: 80px;
            height: 80px;
            background: var(--white);
            border-radius: var(--radius-full);
            position: absolute;
        }

        .accuracy-percentage {
            font-size: 24px;
            font-weight: 700;
            color: var(--success-green);
            z-index: 1;
        }

        .accuracy-description {
            font-size: 12px;
            color: var(--gray-600);
            line-height: 1.5;
        }

        /* 설정 섹션 */
        .settings-section {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }

        .setting-item {
            display: flex;
            align-items: center;
            padding: var(--space-4);
            border-bottom: 1px solid var(--gray-100);
            text-decoration: none;
            color: var(--gray-900);
            transition: background-color 0.2s ease;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-item:hover {
            background: var(--gray-50);
        }

        .setting-icon {
            font-size: 18px;
            margin-right: var(--space-3);
            color: var(--gray-500);
        }

        .setting-content {
            flex: 1;
        }

        .setting-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: var(--space-1);
        }

        .setting-description {
            font-size: 12px;
            color: var(--gray-500);
        }

        .setting-arrow {
            color: var(--gray-400);
            font-size: 12px;
        }

        /* 빈 상태 */
        .empty-state {
            text-align: center;
            padding: var(--space-8);
            color: var(--gray-500);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: var(--space-4);
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: var(--space-2);
        }

        .empty-state-description {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: var(--space-4);
        }

        .empty-state-action {
            background: var(--primary-blue);
            color: white;
            padding: var(--space-3) var(--space-6);
            border-radius: var(--radius-lg);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- 프로필 헤더 -->
    <div class="profile-header">
        <div class="profile-avatar">👤</div>
        <div class="profile-name" id="profileName">음식 탐험가</div>
        <div class="profile-stats">
            <div class="stat-item">
                <span class="stat-number" id="evaluationCount">0</span>
                <span class="stat-label">평가</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="visitCount">0</span>
                <span class="stat-label">방문</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="badgeCount">0</span>
                <span class="stat-label">배지</span>
            </div>
        </div>
    </div>

    <!-- 가성비 기준 섹션 -->
    <div class="dashboard-section">
        <div class="section-header">
            <h2 class="section-title">나의 가성비 기준</h2>
            <a href="#" class="section-action">상세보기</a>
        </div>

        <div class="value-criteria-card" id="valueCriteriaCard">
            <!-- 로딩 또는 데이터 표시 -->
        </div>
    </div>

    <!-- 최근 평가 섹션 -->
    <div class="dashboard-section">
        <div class="section-header">
            <h2 class="section-title">최근 평가</h2>
            <a href="#" class="section-action">전체보기</a>
        </div>

        <div class="recent-evaluations" id="recentEvaluations">
            <!-- JavaScript로 동적 생성 -->
        </div>
    </div>

    <!-- 성과 배지 섹션 -->
    <div class="dashboard-section">
        <div class="section-header">
            <h2 class="section-title">성과 배지</h2>
            <a href="#" class="section-action">전체보기</a>
        </div>

        <div class="achievements">
            <div class="achievement-grid" id="achievementGrid">
                <!-- JavaScript로 동적 생성 -->
            </div>
        </div>
    </div>

    <!-- 추천 정확도 섹션 -->
    <div class="dashboard-section">
        <div class="section-header">
            <h2 class="section-title">추천 정확도</h2>
        </div>

        <div class="accuracy-card">
            <div class="accuracy-circle">
                <span class="accuracy-percentage" id="accuracyRate">-%</span>
            </div>
            <div class="accuracy-description">
                내가 평가한 식당 중 <strong>추천 맛집과 일치하는 비율</strong><br>
                더 많은 평가를 통해 정확도를 높일 수 있어요
            </div>
        </div>
    </div>

    <!-- 설정 섹션 -->
    <div class="dashboard-section">
        <div class="section-header">
            <h2 class="section-title">설정</h2>
        </div>

        <div class="settings-section">
            <a href="#" class="setting-item">
                <div class="setting-icon">🔔</div>
                <div class="setting-content">
                    <div class="setting-title">알림 설정</div>
                    <div class="setting-description">새로운 맛집 추천, 평가 리마인드</div>
                </div>
                <div class="setting-arrow">›</div>
            </a>

            <a href="#" class="setting-item">
                <div class="setting-icon">🎯</div>
                <div class="setting-content">
                    <div class="setting-title">추천 기준 조정</div>
                    <div class="setting-description">가격대, 선호 음식, 거리 등</div>
                </div>
                <div class="setting-arrow">›</div>
            </a>

            <a href="#" class="setting-item">
                <div class="setting-icon">📊</div>
                <div class="setting-content">
                    <div class="setting-title">데이터 내보내기</div>
                    <div class="setting-description">평가 내역 및 분석 데이터</div>
                </div>
                <div class="setting-arrow">›</div>
            </a>

            <a href="#" class="setting-item">
                <div class="setting-icon">❓</div>
                <div class="setting-content">
                    <div class="setting-title">도움말</div>
                    <div class="setting-description">사용법 및 자주 묻는 질문</div>
                </div>
                <div class="setting-arrow">›</div>
            </a>
        </div>
    </div>

    <!-- 하단 네비게이션 -->
    <div class="bottom-nav">
        <div class="bottom-nav-content">
            <a href="#" class="bottom-nav-item" onclick="Utils.navigateTo('01-홈화면')">
                <div class="bottom-nav-icon">🏠</div>
                <div class="bottom-nav-label">홈</div>
            </a>
            <a href="#" class="bottom-nav-item" onclick="Utils.navigateTo('02-검색결과')">
                <div class="bottom-nav-icon">🔍</div>
                <div class="bottom-nav-label">검색</div>
            </a>
            <a href="#" class="bottom-nav-item" onclick="Utils.navigateTo('06-주문상태')">
                <div class="bottom-nav-icon">🍽️</div>
                <div class="bottom-nav-label">주문</div>
            </a>
            <a href="#" class="bottom-nav-item active">
                <div class="bottom-nav-icon">👤</div>
                <div class="bottom-nav-label">내 정보</div>
            </a>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        // 페이지 초기화
        document.addEventListener('DOMContentLoaded', () => {
            initializeAnalysisPage();
        });

        function initializeAnalysisPage() {
            loadUserProfile();
            loadValueCriteria();
            loadRecentEvaluations();
            loadAchievements();
            calculateAccuracy();
        }

        // 사용자 프로필 로드
        function loadUserProfile() {
            const evaluationHistory = Utils.storage.get('evaluationHistory') || [];
            const userProfile = Utils.storage.get('userProfile') || {
                name: '음식 탐험가',
                evaluationCount: 0,
                visitCount: 0,
                badgeCount: 0
            };

            // 프로필 업데이트
            document.getElementById('profileName').textContent = userProfile.name;
            document.getElementById('evaluationCount').textContent = evaluationHistory.length;
            document.getElementById('visitCount').textContent = evaluationHistory.length; // 간소화
            document.getElementById('badgeCount').textContent = calculateBadgeCount(evaluationHistory);
        }

        // 가성비 기준 로드
        function loadValueCriteria() {
            const evaluationHistory = Utils.storage.get('evaluationHistory') || [];
            const container = document.getElementById('valueCriteriaCard');

            if (evaluationHistory.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📊</div>
                        <div class="empty-state-title">아직 평가가 없어요</div>
                        <div class="empty-state-description">
                            식당을 방문하고 평가해주시면<br>개인 맞춤 가성비 기준을 분석해드릴게요
                        </div>
                        <a href="#" class="empty-state-action" onclick="Utils.navigateTo('01-홈화면')">
                            맛집 찾아보기
                        </a>
                    </div>
                `;
                return;
            }

            const criteria = calculateValueCriteria(evaluationHistory);

            container.innerHTML = `
                <div class="radar-chart">
                    <div class="radar-center">
                        <span class="overall-score">${criteria.overall.toFixed(1)}</span>
                        <span class="score-label">종합 점수</span>
                    </div>
                </div>
                <div class="factor-legends">
                    <div class="factor-legend">
                        <div class="factor-color price"></div>
                        <div class="factor-text">가격</div>
                        <div class="factor-score">${criteria.price.toFixed(1)}</div>
                    </div>
                    <div class="factor-legend">
                        <div class="factor-color portion"></div>
                        <div class="factor-text">양</div>
                        <div class="factor-score">${criteria.portion.toFixed(1)}</div>
                    </div>
                    <div class="factor-legend">
                        <div class="factor-color taste"></div>
                        <div class="factor-text">맛</div>
                        <div class="factor-score">${criteria.taste.toFixed(1)}</div>
                    </div>
                    <div class="factor-legend">
                        <div class="factor-color service"></div>
                        <div class="factor-text">서비스</div>
                        <div class="factor-score">${criteria.service.toFixed(1)}</div>
                    </div>
                </div>
            `;
        }

        // 최근 평가 로드
        function loadRecentEvaluations() {
            const evaluationHistory = Utils.storage.get('evaluationHistory') || [];
            const container = document.getElementById('recentEvaluations');

            if (evaluationHistory.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📝</div>
                        <div class="empty-state-title">아직 평가한 식당이 없어요</div>
                        <div class="empty-state-description">
                            식당을 방문하고 가성비를 평가해보세요
                        </div>
                    </div>
                `;
                return;
            }

            // 최근 5개만 표시
            const recentEvaluations = evaluationHistory.slice(-5).reverse();

            container.innerHTML = recentEvaluations.map(evaluation => `
                <div class="evaluation-item">
                    <img src="${evaluation.restaurantImage || 'https://picsum.photos/50/50?random=' + evaluation.id}"
                         alt="${evaluation.restaurantName}"
                         class="evaluation-image">
                    <div class="evaluation-content">
                        <div class="evaluation-restaurant">${evaluation.restaurantName}</div>
                        <div class="evaluation-date">${formatEvaluationDate(evaluation.date)}</div>
                        <div class="evaluation-scores">
                            <div class="score-badge ${getScoreClass(evaluation.factors.price)}">
                                가격 ${evaluation.factors.price}
                            </div>
                            <div class="score-badge ${getScoreClass(evaluation.factors.taste)}">
                                맛 ${evaluation.factors.taste}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 성과 배지 로드
        function loadAchievements() {
            const evaluationHistory = Utils.storage.get('evaluationHistory') || [];
            const container = document.getElementById('achievementGrid');

            const achievements = [
                { id: 'first_review', name: '첫 평가', icon: '🎉', unlocked: evaluationHistory.length >= 1 },
                { id: 'reviewer', name: '리뷰어', icon: '✍️', unlocked: evaluationHistory.length >= 5 },
                { id: 'foodie', name: '푸디', icon: '🍽️', unlocked: evaluationHistory.length >= 10 },
                { id: 'explorer', name: '탐험가', icon: '🗺️', unlocked: getUniqueRestaurants(evaluationHistory) >= 5 },
                { id: 'critic', name: '미식가', icon: '⭐', unlocked: getHighRatingCount(evaluationHistory) >= 3 },
                { id: 'bargain_hunter', name: '가성비왕', icon: '💰', unlocked: getValueRatingCount(evaluationHistory) >= 5 }
            ];

            container.innerHTML = achievements.map(achievement => `
                <div class="achievement-item ${achievement.unlocked ? 'unlocked' : ''}">
                    <div class="achievement-icon">${achievement.icon}</div>
                    <div class="achievement-name">${achievement.name}</div>
                </div>
            `).join('');
        }

        // 추천 정확도 계산
        function calculateAccuracy() {
            const evaluationHistory = Utils.storage.get('evaluationHistory') || [];
            const accuracyElement = document.getElementById('accuracyRate');

            if (evaluationHistory.length < 3) {
                accuracyElement.textContent = '-%';
                return;
            }

            // 간단한 정확도 계산 (실제로는 더 복잡한 알고리즘 사용)
            const highSatisfactionCount = evaluationHistory.filter(e =>
                (e.factors.price + e.factors.portion + e.factors.taste + e.factors.service) / 4 >= 4.0
            ).length;

            const accuracy = Math.round((highSatisfactionCount / evaluationHistory.length) * 100);
            accuracyElement.textContent = `${accuracy}%`;

            // 원형 차트 업데이트
            const circle = document.querySelector('.accuracy-circle');
            const degree = (accuracy / 100) * 360;
            circle.style.background = `conic-gradient(var(--success-green) 0deg ${degree}deg, var(--gray-200) ${degree}deg 360deg)`;
        }

        // 유틸리티 함수들
        function calculateValueCriteria(evaluations) {
            if (evaluations.length === 0) {
                return { price: 0, portion: 0, taste: 0, service: 0, overall: 0 };
            }

            const totals = evaluations.reduce((acc, eval) => ({
                price: acc.price + eval.factors.price,
                portion: acc.portion + eval.factors.portion,
                taste: acc.taste + eval.factors.taste,
                service: acc.service + eval.factors.service
            }), { price: 0, portion: 0, taste: 0, service: 0 });

            const count = evaluations.length;
            const criteria = {
                price: totals.price / count,
                portion: totals.portion / count,
                taste: totals.taste / count,
                service: totals.service / count
            };

            criteria.overall = (criteria.price + criteria.portion + criteria.taste + criteria.service) / 4;

            return criteria;
        }

        function calculateBadgeCount(evaluations) {
            const achievements = [
                evaluations.length >= 1,  // 첫 평가
                evaluations.length >= 5,  // 리뷰어
                evaluations.length >= 10, // 푸디
                getUniqueRestaurants(evaluations) >= 5,  // 탐험가
                getHighRatingCount(evaluations) >= 3,    // 미식가
                getValueRatingCount(evaluations) >= 5    // 가성비왕
            ];

            return achievements.filter(Boolean).length;
        }

        function getUniqueRestaurants(evaluations) {
            const uniqueRestaurants = new Set(evaluations.map(e => e.restaurantId));
            return uniqueRestaurants.size;
        }

        function getHighRatingCount(evaluations) {
            return evaluations.filter(e => {
                const avgRating = (e.factors.price + e.factors.portion + e.factors.taste + e.factors.service) / 4;
                return avgRating >= 4.5;
            }).length;
        }

        function getValueRatingCount(evaluations) {
            return evaluations.filter(e => e.factors.price >= 4.0).length;
        }

        function formatEvaluationDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

            if (diffInDays === 0) return '오늘';
            if (diffInDays === 1) return '어제';
            if (diffInDays < 7) return `${diffInDays}일 전`;
            if (diffInDays < 30) return `${Math.floor(diffInDays / 7)}주 전`;
            return `${Math.floor(diffInDays / 30)}개월 전`;
        }

        function getScoreClass(score) {
            if (score >= 4.5) return 'excellent';
            if (score >= 3.5) return 'good';
            return '';
        }

        // 테스트 데이터 생성 (개발용)
        function generateTestData() {
            const testEvaluations = [
                {
                    id: 'eval1',
                    restaurantId: 'r1',
                    restaurantName: '맛있는 김치찌개',
                    restaurantImage: 'https://picsum.photos/50/50?random=1',
                    date: new Date(Date.now() - 1000 * 60 * 60 * 24).toISOString(), // 1일 전
                    factors: { price: 4.5, portion: 4.2, taste: 4.3, service: 4.1 },
                    overallSatisfaction: 4.3
                },
                {
                    id: 'eval2',
                    restaurantId: 'r2',
                    restaurantName: '파스타 하우스',
                    restaurantImage: 'https://picsum.photos/50/50?random=2',
                    date: new Date(Date.now() - 1000 * 60 * 60 * 24 * 3).toISOString(), // 3일 전
                    factors: { price: 3.5, portion: 4.0, taste: 4.2, service: 3.8 },
                    overallSatisfaction: 3.9
                }
            ];

            Utils.storage.set('evaluationHistory', testEvaluations);
            initializeAnalysisPage();
        }

        // 개발용 테스트 데이터 버튼 (실제 배포시 제거)
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            const testButton = document.createElement('button');
            testButton.textContent = '테스트 데이터 생성';
            testButton.style.position = 'fixed';
            testButton.style.top = '10px';
            testButton.style.right = '10px';
            testButton.style.zIndex = '9999';
            testButton.style.padding = '8px 12px';
            testButton.style.background = '#ff4444';
            testButton.style.color = 'white';
            testButton.style.border = 'none';
            testButton.style.borderRadius = '4px';
            testButton.style.fontSize = '12px';
            testButton.onclick = generateTestData;
            document.body.appendChild(testButton);
        }
    </script>
</body>
</html>