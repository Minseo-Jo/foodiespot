<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ë¬¸ ê²°ì œ - í‘¸ë””ìŠ¤íŒŸ</title>
    <link rel="stylesheet" href="common.css">
</head>
<body>
    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <button class="btn-ghost back-button" aria-label="ë’¤ë¡œê°€ê¸°">
                    <span style="font-size: 18px;">â†</span>
                </button>
                <h1 class="navbar-title">ì£¼ë¬¸ ê²°ì œ</h1>
                <div style="width: 44px;"></div> <!-- ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•œ ë”ë¯¸ ìš”ì†Œ -->
            </div>
        </div>
    </nav>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <main class="container">
        <!-- ì£¼ë¬¸ ì •ë³´ -->
        <section class="order-info card">
            <div class="section-header">
                <h2 class="heading-3">ì£¼ë¬¸ ì •ë³´</h2>
                <button class="btn-ghost" id="editOrderBtn">ìˆ˜ì •</button>
            </div>

            <div class="restaurant-info">
                <h3 id="restaurantName" class="restaurant-name">ë§›ìˆëŠ” ê¹€ì¹˜ì°Œê°œ</h3>
                <p id="restaurantAddress" class="restaurant-address">ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123</p>
            </div>

            <div class="order-items" id="orderItems">
                <!-- ì£¼ë¬¸ ì•„ì´í…œë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
        </section>

        <!-- í• ì¸ ë° ì¿ í° -->
        <section class="discount-section card">
            <h2 class="heading-3">í• ì¸ í˜œíƒ</h2>

            <div class="coupon-section">
                <div class="coupon-input-group">
                    <input type="text" id="couponCode" class="input" placeholder="ì¿ í° ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    <button class="btn-secondary" id="applyCouponBtn">ì ìš©</button>
                </div>

                <div class="available-coupons" id="availableCoupons">
                    <h4 class="subsection-title">ì‚¬ìš© ê°€ëŠ¥í•œ ì¿ í°</h4>
                    <div class="coupon-list">
                        <div class="coupon-item" data-coupon-id="welcome" data-discount="1000">
                            <div class="coupon-info">
                                <span class="coupon-name">ì‹ ê·œ ê°€ì… ì¶•í•˜ ì¿ í°</span>
                                <span class="coupon-discount">1,000ì› í• ì¸</span>
                            </div>
                            <button class="coupon-apply-btn">ì„ íƒ</button>
                        </div>
                        <div class="coupon-item" data-coupon-id="value10" data-discount="0.1" data-type="percentage">
                            <div class="coupon-info">
                                <span class="coupon-name">ê°€ì„±ë¹„ ë¦¬ë·° ì¿ í°</span>
                                <span class="coupon-discount">10% í• ì¸</span>
                            </div>
                            <button class="coupon-apply-btn">ì„ íƒ</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="point-section">
                <div class="point-input-group">
                    <label for="pointAmount" class="point-label">
                        ì ë¦½ê¸ˆ ì‚¬ìš© (ë³´ìœ : 3,500P)
                    </label>
                    <div class="point-controls">
                        <input type="number" id="pointAmount" class="input point-input" placeholder="0" min="0" max="3500">
                        <button class="btn-ghost" id="useAllPointsBtn">ì „ì•¡ ì‚¬ìš©</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ê²°ì œ ìˆ˜ë‹¨ -->
        <section class="payment-section card">
            <h2 class="heading-3">ê²°ì œ ìˆ˜ë‹¨</h2>

            <div class="payment-methods">
                <label class="payment-method">
                    <input type="radio" name="payment" value="card" checked>
                    <div class="method-info">
                        <span class="method-icon">ğŸ’³</span>
                        <div class="method-details">
                            <span class="method-name">ì¹´ë“œ ê²°ì œ</span>
                            <span class="method-description">ëª¨ë“  ì‹ ìš©/ì²´í¬ì¹´ë“œ</span>
                        </div>
                    </div>
                    <span class="method-arrow">></span>
                </label>

                <label class="payment-method">
                    <input type="radio" name="payment" value="kakaopay">
                    <div class="method-info">
                        <span class="method-icon">ğŸ’›</span>
                        <div class="method-details">
                            <span class="method-name">ì¹´ì¹´ì˜¤í˜ì´</span>
                            <span class="method-description">ê°„í¸ ê²°ì œ</span>
                        </div>
                    </div>
                    <span class="method-arrow">></span>
                </label>

                <label class="payment-method">
                    <input type="radio" name="payment" value="naverpay">
                    <div class="method-info">
                        <span class="method-icon">ğŸ’š</span>
                        <div class="method-details">
                            <span class="method-name">ë„¤ì´ë²„í˜ì´</span>
                            <span class="method-description">ê°„í¸ ê²°ì œ</span>
                        </div>
                    </div>
                    <span class="method-arrow">></span>
                </label>

                <label class="payment-method">
                    <input type="radio" name="payment" value="toss">
                    <div class="method-info">
                        <span class="method-icon">ğŸ’™</span>
                        <div class="method-details">
                            <span class="method-name">í† ìŠ¤í˜ì´</span>
                            <span class="method-description">ê°„í¸ ê²°ì œ</span>
                        </div>
                    </div>
                    <span class="method-arrow">></span>
                </label>
            </div>
        </section>

        <!-- ì£¼ë¬¸ ë©”ëª¨ -->
        <section class="memo-section card">
            <h2 class="heading-3">ì£¼ë¬¸ ë©”ëª¨</h2>
            <textarea
                id="orderMemo"
                class="memo-input"
                placeholder="ê°€ê²Œì— ì „ë‹¬í•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: ëœ ë§µê²Œ í•´ì£¼ì„¸ìš”)"
                rows="3"
                maxlength="200"
            ></textarea>
            <div class="memo-counter">
                <span id="memoCount">0</span>/200
            </div>
        </section>

        <!-- ê°€ê²© ìš”ì•½ -->
        <section class="price-summary card">
            <h2 class="heading-3">ê²°ì œ ê¸ˆì•¡</h2>

            <div class="price-breakdown">
                <div class="price-row">
                    <span>ì£¼ë¬¸ ê¸ˆì•¡</span>
                    <span id="subtotalPrice">0ì›</span>
                </div>
                <div class="price-row" id="couponDiscountRow" style="display: none;">
                    <span class="discount-label">ì¿ í° í• ì¸</span>
                    <span id="couponDiscount" class="discount-amount">-0ì›</span>
                </div>
                <div class="price-row" id="pointDiscountRow" style="display: none;">
                    <span class="discount-label">ì ë¦½ê¸ˆ ì‚¬ìš©</span>
                    <span id="pointDiscount" class="discount-amount">-0ì›</span>
                </div>
                <div class="price-row total-row">
                    <span class="total-label">ìµœì¢… ê²°ì œ ê¸ˆì•¡</span>
                    <span id="finalPrice" class="total-amount">0ì›</span>
                </div>
            </div>
        </section>

        <!-- ì•½ê´€ ë™ì˜ -->
        <section class="terms-section">
            <div class="terms-agreement">
                <label class="checkbox-item">
                    <input type="checkbox" id="agreeAll" class="agreement-checkbox">
                    <span class="checkbox-label">ì „ì²´ ë™ì˜</span>
                </label>

                <div class="terms-details">
                    <label class="checkbox-item">
                        <input type="checkbox" class="agreement-checkbox required" data-term="service">
                        <span class="checkbox-label">
                            ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€ ë™ì˜
                            <span class="required-mark">(í•„ìˆ˜)</span>
                        </span>
                        <button class="terms-detail-btn" data-term="service">ë³´ê¸°</button>
                    </label>

                    <label class="checkbox-item">
                        <input type="checkbox" class="agreement-checkbox required" data-term="privacy">
                        <span class="checkbox-label">
                            ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ ë™ì˜
                            <span class="required-mark">(í•„ìˆ˜)</span>
                        </span>
                        <button class="terms-detail-btn" data-term="privacy">ë³´ê¸°</button>
                    </label>

                    <label class="checkbox-item">
                        <input type="checkbox" class="agreement-checkbox" data-term="marketing">
                        <span class="checkbox-label">
                            ë§ˆì¼€íŒ… ì •ë³´ ìˆ˜ì‹  ë™ì˜
                            <span class="optional-mark">(ì„ íƒ)</span>
                        </span>
                        <button class="terms-detail-btn" data-term="marketing">ë³´ê¸°</button>
                    </label>
                </div>
            </div>
        </section>
    </main>

    <!-- ê²°ì œ ë²„íŠ¼ -->
    <div class="payment-action">
        <button class="btn-primary payment-btn" id="paymentBtn" disabled>
            <span id="paymentBtnText">ê²°ì œí•˜ê¸°</span>
            <span id="paymentBtnPrice">0ì›</span>
        </button>
    </div>

    <!-- ì•½ê´€ ìƒì„¸ ëª¨ë‹¬ -->
    <div id="termsModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTermsTitle" class="heading-3">ì•½ê´€</h3>
                <button class="modal-close" aria-label="ë‹«ê¸°">Ã—</button>
            </div>
            <div class="modal-body">
                <div id="modalTermsContent" class="terms-content">
                    <!-- ì•½ê´€ ë‚´ìš©ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ê²°ì œ ì²˜ë¦¬ ë¡œë”© ëª¨ë‹¬ -->
    <div id="paymentLoadingModal" class="modal hidden">
        <div class="modal-content loading-modal">
            <div class="loading-content">
                <div class="spinner large"></div>
                <h3 class="loading-title">ê²°ì œ ì²˜ë¦¬ ì¤‘...</h3>
                <p class="loading-description">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentOrder = null;
        let appliedCoupon = null;
        let usedPoints = 0;
        let subtotal = 0;
        let finalTotal = 0;

        // í˜ì´ì§€ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initOrderPayment();
        });

        function initOrderPayment() {
            // ì£¼ë¬¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            currentOrder = Utils.session.get('currentOrder');
            if (!currentOrder) {
                Utils.showToast('ì£¼ë¬¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                Utils.goBack();
                return;
            }

            // UI ì´ˆê¸°í™”
            displayOrderInfo();
            calculatePrices();
            setupEventListeners();
        }

        function displayOrderInfo() {
            // ì‹ë‹¹ ì •ë³´ í‘œì‹œ
            document.getElementById('restaurantName').textContent = currentOrder.restaurant.name;
            document.getElementById('restaurantAddress').textContent = currentOrder.restaurant.address;

            // ì£¼ë¬¸ ì•„ì´í…œ í‘œì‹œ
            const orderItemsContainer = document.getElementById('orderItems');
            orderItemsContainer.innerHTML = '';

            currentOrder.items.forEach(item => {
                const orderItem = createOrderItemElement(item);
                orderItemsContainer.appendChild(orderItem);
            });
        }

        function createOrderItemElement(item) {
            const orderItem = document.createElement('div');
            orderItem.className = 'order-item';

            const options = item.options ? Object.entries(item.options).map(([key, value]) => {
                const optionNames = {
                    spicy: 'ë§µê¸°'
                };
                const valueNames = {
                    mild: 'ìˆœí•œë§›',
                    medium: 'ë³´í†µ',
                    hot: 'ë§¤ìš´ë§›'
                };
                return `${optionNames[key] || key}: ${valueNames[value] || value}`;
            }).join(', ') : '';

            orderItem.innerHTML = `
                <div class="item-info">
                    <h4 class="item-name">${item.name}</h4>
                    ${options ? `<p class="item-options">${options}</p>` : ''}
                </div>
                <div class="item-quantity">
                    <span>${item.quantity}ê°œ</span>
                </div>
                <div class="item-price">
                    <span>${Utils.formatPrice(item.price * item.quantity)}</span>
                </div>
            `;

            return orderItem;
        }

        function calculatePrices() {
            // ì£¼ë¬¸ ê¸ˆì•¡ ê³„ì‚°
            subtotal = currentOrder.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            // ì¿ í° í• ì¸ ê³„ì‚°
            let couponDiscount = 0;
            if (appliedCoupon) {
                if (appliedCoupon.type === 'percentage') {
                    couponDiscount = Math.floor(subtotal * appliedCoupon.discount);
                } else {
                    couponDiscount = appliedCoupon.discount;
                }
            }

            // ì ë¦½ê¸ˆ í• ì¸ì€ ê·¸ëŒ€ë¡œ ì‚¬ìš©
            const pointDiscount = usedPoints;

            // ìµœì¢… ê¸ˆì•¡ ê³„ì‚°
            finalTotal = Math.max(0, subtotal - couponDiscount - pointDiscount);

            // UI ì—…ë°ì´íŠ¸
            updatePriceDisplay(subtotal, couponDiscount, pointDiscount, finalTotal);
        }

        function updatePriceDisplay(subtotal, couponDiscount, pointDiscount, finalTotal) {
            document.getElementById('subtotalPrice').textContent = Utils.formatPrice(subtotal);

            // ì¿ í° í• ì¸
            const couponRow = document.getElementById('couponDiscountRow');
            if (couponDiscount > 0) {
                couponRow.style.display = 'flex';
                document.getElementById('couponDiscount').textContent = `-${Utils.formatPrice(couponDiscount)}`;
            } else {
                couponRow.style.display = 'none';
            }

            // ì ë¦½ê¸ˆ í• ì¸
            const pointRow = document.getElementById('pointDiscountRow');
            if (pointDiscount > 0) {
                pointRow.style.display = 'flex';
                document.getElementById('pointDiscount').textContent = `-${Utils.formatPrice(pointDiscount)}`;
            } else {
                pointRow.style.display = 'none';
            }

            // ìµœì¢… ê¸ˆì•¡
            document.getElementById('finalPrice').textContent = Utils.formatPrice(finalTotal);
            document.getElementById('paymentBtnPrice').textContent = Utils.formatPrice(finalTotal);

            // ê²°ì œ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
            updatePaymentButton();
        }

        function setupEventListeners() {
            // ì£¼ë¬¸ ìˆ˜ì •
            document.getElementById('editOrderBtn').addEventListener('click', function() {
                Utils.goBack();
            });

            // ì¿ í° ì ìš©
            document.getElementById('applyCouponBtn').addEventListener('click', function() {
                const couponCode = document.getElementById('couponCode').value.trim();
                applyCouponByCode(couponCode);
            });

            // ì‚¬ìš© ê°€ëŠ¥í•œ ì¿ í° ì„ íƒ
            const couponApplyBtns = document.querySelectorAll('.coupon-apply-btn');
            couponApplyBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const couponItem = this.closest('.coupon-item');
                    const couponId = couponItem.dataset.couponId;
                    const discount = parseFloat(couponItem.dataset.discount);
                    const type = couponItem.dataset.type || 'fixed';
                    applyCoupon({ id: couponId, discount, type });
                });
            });

            // ì ë¦½ê¸ˆ ì‚¬ìš©
            const pointInput = document.getElementById('pointAmount');
            pointInput.addEventListener('input', function() {
                const amount = Math.min(parseInt(this.value) || 0, 3500);
                this.value = amount;
                usedPoints = amount;
                calculatePrices();
            });

            document.getElementById('useAllPointsBtn').addEventListener('click', function() {
                const maxPoints = Math.min(3500, subtotal - (appliedCoupon ? appliedCoupon.discount : 0));
                document.getElementById('pointAmount').value = maxPoints;
                usedPoints = maxPoints;
                calculatePrices();
            });

            // ê²°ì œ ìˆ˜ë‹¨ ì„ íƒ
            const paymentMethods = document.querySelectorAll('input[name="payment"]');
            paymentMethods.forEach(method => {
                method.addEventListener('change', function() {
                    updatePaymentButton();
                });
            });

            // ì£¼ë¬¸ ë©”ëª¨
            const memoInput = document.getElementById('orderMemo');
            memoInput.addEventListener('input', function() {
                const count = this.value.length;
                document.getElementById('memoCount').textContent = count;

                if (count > 200) {
                    this.value = this.value.substring(0, 200);
                    document.getElementById('memoCount').textContent = 200;
                }
            });

            // ì•½ê´€ ë™ì˜
            setupAgreementHandlers();

            // ê²°ì œ ë²„íŠ¼
            document.getElementById('paymentBtn').addEventListener('click', function() {
                processPayment();
            });

            // ëª¨ë‹¬ ê´€ë ¨
            setupModalHandlers();
        }

        function applyCouponByCode(code) {
            // ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ ì¿ í° ê²€ì¦
            const mockCoupons = {
                'WELCOME': { id: 'welcome', discount: 1000, type: 'fixed' },
                'NEWBIE': { id: 'newbie', discount: 2000, type: 'fixed' },
                'SAVE10': { id: 'save10', discount: 0.1, type: 'percentage' }
            };

            const coupon = mockCoupons[code.toUpperCase()];
            if (coupon) {
                applyCoupon(coupon);
                document.getElementById('couponCode').value = '';
            } else {
                Utils.showToast('ìœ íš¨í•˜ì§€ ì•Šì€ ì¿ í° ì½”ë“œì…ë‹ˆë‹¤.', 'error');
            }
        }

        function applyCoupon(coupon) {
            appliedCoupon = coupon;
            calculatePrices();

            // ì¿ í° ë²„íŠ¼ë“¤ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.coupon-apply-btn').forEach(btn => {
                btn.textContent = 'ì„ íƒ';
                btn.disabled = false;
            });

            // ì„ íƒëœ ì¿ í° ë²„íŠ¼ ì—…ë°ì´íŠ¸
            const selectedBtn = document.querySelector(`[data-coupon-id="${coupon.id}"] .coupon-apply-btn`);
            if (selectedBtn) {
                selectedBtn.textContent = 'ì ìš©ë¨';
                selectedBtn.disabled = true;
            }

            Utils.showToast('ì¿ í°ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        function setupAgreementHandlers() {
            const agreeAllCheckbox = document.getElementById('agreeAll');
            const agreementCheckboxes = document.querySelectorAll('.agreement-checkbox:not(#agreeAll)');

            // ì „ì²´ ë™ì˜ í´ë¦­
            agreeAllCheckbox.addEventListener('change', function() {
                agreementCheckboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                updatePaymentButton();
            });

            // ê°œë³„ ì•½ê´€ ë™ì˜ í´ë¦­
            agreementCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    // ì „ì²´ ë™ì˜ ìƒíƒœ ì—…ë°ì´íŠ¸
                    const allChecked = Array.from(agreementCheckboxes).every(cb => cb.checked);
                    agreeAllCheckbox.checked = allChecked;
                    updatePaymentButton();
                });
            });

            // ì•½ê´€ ìƒì„¸ ë³´ê¸°
            document.querySelectorAll('.terms-detail-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const term = this.dataset.term;
                    showTermsDetail(term);
                });
            });
        }

        function showTermsDetail(term) {
            const titles = {
                service: 'ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€',
                privacy: 'ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨',
                marketing: 'ë§ˆì¼€íŒ… ì •ë³´ ìˆ˜ì‹  ë™ì˜'
            };

            const contents = {
                service: `
                    <h4>ì œ1ì¡° (ëª©ì )</h4>
                    <p>ë³¸ ì•½ê´€ì€ í‘¸ë””ìŠ¤íŒŸì´ ì œê³µí•˜ëŠ” ì„œë¹„ìŠ¤ì˜ ì´ìš©ì¡°ê±´ ë° ì ˆì°¨, íšŒì‚¬ì™€ íšŒì›ì˜ ê¶Œë¦¬, ì˜ë¬´ ë° ì±…ì„ì‚¬í•­ì„ ê·œì •í•¨ì„ ëª©ì ìœ¼ë¡œ í•©ë‹ˆë‹¤.</p>

                    <h4>ì œ2ì¡° (ì •ì˜)</h4>
                    <p>1. "ì„œë¹„ìŠ¤"ë¼ í•¨ì€ íšŒì‚¬ê°€ ì œê³µí•˜ëŠ” ë§›ì§‘ ì¶”ì²œ ë° ì£¼ë¬¸ ì„œë¹„ìŠ¤ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.</p>
                    <p>2. "íšŒì›"ì´ë¼ í•¨ì€ ë³¸ ì•½ê´€ì— ë™ì˜í•˜ê³  ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ëŠ” ìë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.</p>
                `,
                privacy: `
                    <h4>ê°œì¸ì •ë³´ì˜ ìˆ˜ì§‘ ë° ì´ìš©ëª©ì </h4>
                    <p>íšŒì‚¬ëŠ” ë‹¤ìŒì˜ ëª©ì ì„ ìœ„í•˜ì—¬ ê°œì¸ì •ë³´ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.</p>
                    <ul>
                        <li>ì„œë¹„ìŠ¤ ì œê³µ ë° ìš´ì˜</li>
                        <li>ì£¼ë¬¸ ì²˜ë¦¬ ë° ë°°ì†¡</li>
                        <li>ê³ ê°ìƒë‹´ ë° ë¶ˆë§Œì²˜ë¦¬</li>
                        <li>ë§ì¶¤í˜• ì„œë¹„ìŠ¤ ì œê³µ</li>
                    </ul>
                `,
                marketing: `
                    <h4>ë§ˆì¼€íŒ… ì •ë³´ ìˆ˜ì‹  ë™ì˜</h4>
                    <p>ë‹¤ìŒê³¼ ê°™ì€ ë§ˆì¼€íŒ… ì •ë³´ë¥¼ ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    <ul>
                        <li>ì‹ ê·œ ì„œë¹„ìŠ¤ ë° ì´ë²¤íŠ¸ ì•ˆë‚´</li>
                        <li>í• ì¸ ì¿ í° ë° í”„ë¡œëª¨ì…˜ ì •ë³´</li>
                        <li>ë§ì¶¤í˜• ë§›ì§‘ ì¶”ì²œ</li>
                    </ul>
                    <p>ì–¸ì œë“ ì§€ ìˆ˜ì‹  ê±°ë¶€í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                `
            };

            document.getElementById('modalTermsTitle').textContent = titles[term];
            document.getElementById('modalTermsContent').innerHTML = contents[term];
            document.getElementById('termsModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function updatePaymentButton() {
            const requiredCheckboxes = document.querySelectorAll('.agreement-checkbox.required');
            const allRequiredChecked = Array.from(requiredCheckboxes).every(cb => cb.checked);
            const paymentBtn = document.getElementById('paymentBtn');

            paymentBtn.disabled = !allRequiredChecked || finalTotal <= 0;
        }

        function setupModalHandlers() {
            // ëª¨ë‹¬ ë‹«ê¸°
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.closest('.modal').classList.add('hidden');
                    document.body.style.overflow = 'auto';
                });
            });

            // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ì‹œ ë‹«ê¸°
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                        document.body.style.overflow = 'auto';
                    }
                });
            });
        }

        async function processPayment() {
            try {
                // ë¡œë”© ëª¨ë‹¬ í‘œì‹œ
                showPaymentLoading();

                // ê²°ì œ ì •ë³´ êµ¬ì„±
                const paymentInfo = {
                    orderId: generateOrderId(),
                    restaurant: currentOrder.restaurant,
                    items: currentOrder.items,
                    paymentMethod: document.querySelector('input[name="payment"]:checked').value,
                    subtotal: subtotal,
                    discount: (appliedCoupon ? appliedCoupon.discount : 0) + usedPoints,
                    finalAmount: finalTotal,
                    memo: document.getElementById('orderMemo').value.trim(),
                    timestamp: Date.now()
                };

                // ê²°ì œ ì²˜ë¦¬ ì‹œë®¬ë ˆì´ì…˜
                await simulatePaymentProcess();

                // ê²°ì œ ì™„ë£Œ ì •ë³´ ì €ì¥
                Utils.session.set('completedOrder', paymentInfo);
                Utils.session.remove('currentOrder');
                Utils.session.remove(`cart_${currentOrder.restaurant.id}`);

                // ì£¼ë¬¸ ìƒíƒœ í˜ì´ì§€ë¡œ ì´ë™
                Utils.navigateTo('06-ì£¼ë¬¸ìƒíƒœ');

            } catch (error) {
                hidePaymentLoading();
                console.error('Payment error:', error);
                Utils.showToast('ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
            }
        }

        function generateOrderId() {
            return 'ORD' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substr(2, 5).toUpperCase();
        }

        function simulatePaymentProcess() {
            return new Promise((resolve, reject) => {
                // 2-3ì´ˆê°„ ê²°ì œ ì²˜ë¦¬ ì‹œë®¬ë ˆì´ì…˜
                setTimeout(() => {
                    // 95% í™•ë¥ ë¡œ ì„±ê³µ
                    if (Math.random() > 0.05) {
                        resolve();
                    } else {
                        reject(new Error('Payment failed'));
                    }
                }, Math.random() * 1000 + 2000); // 2-3ì´ˆ ëœë¤ ì§€ì—°
            });
        }

        function showPaymentLoading() {
            document.getElementById('paymentLoadingModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function hidePaymentLoading() {
            document.getElementById('paymentLoadingModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
    </script>

    <style>
        /* ì£¼ë¬¸ ê²°ì œ í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */
        main {
            padding-bottom: 120px; /* ê³ ì • ê²°ì œ ë²„íŠ¼ ë•Œë¬¸ì— */
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
        }

        .restaurant-info {
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-4);
            border-bottom: 1px solid var(--gray-200);
        }

        .restaurant-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: var(--space-1);
        }

        .restaurant-address {
            color: var(--gray-600);
            font-size: 14px;
        }

        .order-items {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3);
            background: var(--gray-50);
            border-radius: var(--radius-lg);
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: var(--space-1);
        }

        .item-options {
            font-size: 12px;
            color: var(--gray-500);
        }

        .item-quantity {
            margin-right: var(--space-4);
            color: var(--gray-700);
            font-weight: 500;
        }

        .item-price {
            font-weight: 600;
            color: var(--primary-blue);
        }

        /* í• ì¸ ì„¹ì…˜ */
        .coupon-input-group {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-4);
        }

        .coupon-input-group .input {
            flex: 1;
        }

        .subsection-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: var(--space-3);
        }

        .coupon-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .coupon-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            background: var(--white);
        }

        .coupon-info {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .coupon-name {
            font-weight: 500;
            color: var(--gray-900);
        }

        .coupon-discount {
            font-size: 14px;
            color: var(--food-orange);
            font-weight: 600;
        }

        .coupon-apply-btn {
            padding: var(--space-2) var(--space-4);
            background: var(--primary-blue);
            color: var(--white);
            border: none;
            border-radius: var(--radius-md);
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .coupon-apply-btn:hover {
            background: var(--primary-blue-dark);
        }

        .coupon-apply-btn:disabled {
            background: var(--success-green);
            cursor: not-allowed;
        }

        .point-section {
            margin-top: var(--space-4);
            padding-top: var(--space-4);
            border-top: 1px solid var(--gray-200);
        }

        .point-label {
            display: block;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: var(--space-3);
        }

        .point-controls {
            display: flex;
            gap: var(--space-2);
            align-items: center;
        }

        .point-input {
            flex: 1;
        }

        /* ê²°ì œ ìˆ˜ë‹¨ */
        .payment-methods {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .payment-method {
            display: flex;
            align-items: center;
            padding: var(--space-4);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .payment-method:has(input:checked) {
            border-color: var(--primary-blue);
            background: var(--primary-blue-light);
        }

        .payment-method input {
            display: none;
        }

        .method-info {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            flex: 1;
        }

        .method-icon {
            font-size: 24px;
        }

        .method-details {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .method-name {
            font-weight: 600;
            color: var(--gray-900);
        }

        .method-description {
            font-size: 12px;
            color: var(--gray-500);
        }

        .method-arrow {
            color: var(--gray-400);
            font-weight: 600;
        }

        /* ë©”ëª¨ ì„¹ì…˜ */
        .memo-input {
            width: 100%;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            font-family: inherit;
            font-size: 14px;
            resize: none;
            transition: border-color 0.2s ease;
        }

        .memo-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .memo-counter {
            text-align: right;
            margin-top: var(--space-2);
            font-size: 12px;
            color: var(--gray-500);
        }

        /* ê°€ê²© ìš”ì•½ */
        .price-breakdown {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .price-row.total-row {
            padding-top: var(--space-3);
            border-top: 2px solid var(--primary-blue);
            margin-top: var(--space-2);
        }

        .discount-label {
            color: var(--success-green);
        }

        .discount-amount {
            color: var(--success-green);
            font-weight: 600;
        }

        .total-label {
            font-weight: 600;
            font-size: 16px;
            color: var(--gray-900);
        }

        .total-amount {
            font-weight: 700;
            font-size: 20px;
            color: var(--primary-blue);
        }

        /* ì•½ê´€ ë™ì˜ */
        .terms-section {
            margin-bottom: var(--space-6);
        }

        .terms-agreement {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-3);
            cursor: pointer;
            position: relative;
        }

        .checkbox-item:last-child {
            margin-bottom: 0;
        }

        .agreement-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-sm);
            appearance: none;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }

        .agreement-checkbox:checked {
            background: var(--primary-blue);
            border-color: var(--primary-blue);
        }

        .agreement-checkbox:checked::after {
            content: 'âœ“';
            color: var(--white);
            font-size: 14px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .checkbox-label {
            flex: 1;
            font-weight: 500;
            color: var(--gray-700);
        }

        .required-mark {
            color: var(--error-red);
            font-size: 12px;
        }

        .optional-mark {
            color: var(--gray-500);
            font-size: 12px;
        }

        .terms-detail-btn {
            padding: var(--space-1) var(--space-2);
            background: none;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            color: var(--gray-600);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .terms-detail-btn:hover {
            background: var(--gray-100);
            border-color: var(--gray-400);
        }

        .terms-details {
            margin-top: var(--space-3);
            padding-top: var(--space-3);
            border-top: 1px solid var(--gray-200);
        }

        .terms-details .checkbox-item {
            margin-left: var(--space-6);
        }

        /* ê²°ì œ ë²„íŠ¼ */
        .payment-action {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: var(--space-4);
            background: var(--white);
            border-top: 1px solid var(--gray-200);
            z-index: 1000;
        }

        .payment-btn {
            width: 100%;
            height: 56px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .payment-btn:disabled {
            background: var(--gray-300);
            color: var(--gray-500);
            cursor: not-allowed;
        }

        /* ì•½ê´€ ëª¨ë‹¬ */
        .terms-content {
            line-height: 1.6;
        }

        .terms-content h4 {
            color: var(--gray-900);
            font-weight: 600;
            margin: var(--space-4) 0 var(--space-2) 0;
        }

        .terms-content h4:first-child {
            margin-top: 0;
        }

        .terms-content p {
            color: var(--gray-700);
            margin-bottom: var(--space-2);
        }

        .terms-content ul {
            padding-left: var(--space-4);
            margin-bottom: var(--space-3);
        }

        .terms-content li {
            color: var(--gray-700);
            margin-bottom: var(--space-1);
        }

        /* ë¡œë”© ëª¨ë‹¬ */
        .loading-modal {
            text-align: center;
            padding: var(--space-8);
        }

        .loading-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-4);
        }

        .spinner.large {
            width: 48px;
            height: 48px;
            border-width: 4px;
        }

        .loading-title {
            color: var(--gray-900);
            margin: 0;
        }

        .loading-description {
            color: var(--gray-600);
            margin: 0;
        }
    </style>
</body>
</html>