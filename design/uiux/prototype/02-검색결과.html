<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²€ìƒ‰ê²°ê³¼ - ë§›ì§‘ ì¶”ì²œ ì„œë¹„ìŠ¤</title>
    <link rel="stylesheet" href="common.css">
    <style>
        body {
            padding-bottom: 80px;
        }

        .search-header {
            background: var(--white);
            padding: var(--space-4);
            border-bottom: 1px solid var(--gray-200);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .search-bar {
            position: relative;
            margin-bottom: var(--space-3);
        }

        .search-input {
            width: 100%;
            padding: var(--space-3) var(--space-10) var(--space-3) var(--space-4);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-xl);
            font-size: 16px;
            background: var(--gray-50);
        }

        .search-input:focus {
            background: var(--white);
            border-color: var(--primary-blue);
        }

        .search-back {
            position: absolute;
            left: var(--space-3);
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-600);
            font-size: 18px;
            cursor: pointer;
        }

        .search-clear {
            position: absolute;
            right: var(--space-3);
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
            font-size: 18px;
            cursor: pointer;
        }

        .search-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: var(--gray-600);
        }

        .result-count {
            font-weight: 600;
            color: var(--gray-900);
        }

        .filter-controls {
            background: var(--white);
            padding: var(--space-3) var(--space-4);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            gap: var(--space-2);
            overflow-x: auto;
        }

        .sort-button {
            flex-shrink: 0;
            padding: var(--space-2) var(--space-4);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-xl);
            background: var(--white);
            color: var(--gray-700);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sort-button.active {
            background: var(--primary-blue);
            color: var(--white);
            border-color: var(--primary-blue);
        }

        .filter-chip {
            flex-shrink: 0;
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-xl);
            background: var(--white);
            color: var(--gray-700);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .filter-chip.active {
            background: var(--food-orange-light);
            color: var(--food-orange-dark);
            border-color: var(--food-orange);
        }

        .filter-chip.active::after {
            content: 'Ã—';
            margin-left: var(--space-1);
            font-weight: bold;
        }

        .results-container {
            padding: 0 var(--space-4);
        }

        .restaurant-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
            padding: var(--space-4) 0;
        }

        .restaurant-item {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .restaurant-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }

        .restaurant-content {
            display: flex;
            padding: var(--space-4);
            gap: var(--space-4);
        }

        .restaurant-image {
            flex-shrink: 0;
            width: 80px;
            height: 80px;
            border-radius: var(--radius-md);
            object-fit: cover;
            background: var(--gray-200);
        }

        .restaurant-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .restaurant-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-2);
        }

        .restaurant-title {
            flex: 1;
        }

        .restaurant-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: var(--space-1);
        }

        .restaurant-category {
            font-size: 12px;
            color: var(--gray-500);
        }

        .restaurant-metrics {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .metrics-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .distance-info {
            font-size: 12px;
            color: var(--gray-500);
        }

        .price-info {
            font-size: 12px;
            color: var(--gray-600);
        }

        .view-toggle {
            position: fixed;
            bottom: 90px;
            right: var(--space-4);
            background: var(--primary-blue);
            color: var(--white);
            border: none;
            border-radius: var(--radius-full);
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            z-index: 10;
        }

        .no-results {
            text-align: center;
            padding: var(--space-16);
            color: var(--gray-500);
        }

        .no-results-icon {
            font-size: 48px;
            margin-bottom: var(--space-4);
            opacity: 0.5;
        }

        .no-results-text {
            font-size: 16px;
            margin-bottom: var(--space-2);
        }

        .no-results-suggestion {
            font-size: 14px;
            color: var(--gray-400);
        }

        .loading-item {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: var(--space-4);
        }

        .loading-content {
            display: flex;
            gap: var(--space-4);
        }

        .loading-image {
            width: 80px;
            height: 80px;
            border-radius: var(--radius-md);
        }

        .loading-details {
            flex: 1;
        }

        .loading-line {
            height: 16px;
            margin-bottom: var(--space-2);
        }

        .loading-line.short {
            width: 60%;
        }

        .loading-line.medium {
            width: 80%;
        }

        /* ì§€ë„ ë·° (ì¶”í›„ êµ¬í˜„) */
        .map-view {
            height: 400px;
            background: var(--gray-100);
            display: none;
            align-items: center;
            justify-content: center;
            color: var(--gray-500);
            font-size: 14px;
        }

        /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-top: 1px solid var(--gray-200);
            padding: var(--space-2) 0;
            z-index: 1000;
        }

        .bottom-nav-content {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--space-2);
            text-decoration: none;
            color: var(--gray-500);
            transition: color 0.2s ease;
        }

        .bottom-nav-item.active {
            color: var(--primary-blue);
        }

        .bottom-nav-icon {
            font-size: 20px;
            margin-bottom: var(--space-1);
        }

        .bottom-nav-label {
            font-size: 10px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- ê²€ìƒ‰ í—¤ë” -->
    <div class="search-header">
        <div class="search-bar">
            <span class="search-back" onclick="Utils.goBack()">â†</span>
            <input type="text" class="search-input" id="searchInput" placeholder="ì‹ë‹¹, ë©”ë‰´ë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”">
            <span class="search-clear" onclick="clearSearch()">Ã—</span>
        </div>
        <div class="search-summary">
            <span class="result-count" id="resultCount">ê²€ìƒ‰ ì¤‘...</span>
            <span id="searchLocation">ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ ì£¼ë³€</span>
        </div>
    </div>

    <!-- í•„í„° ì»¨íŠ¸ë¡¤ -->
    <div class="filter-controls">
        <button class="sort-button active" data-sort="distance">ê°€ê¹Œìš´ ìˆœ</button>
        <button class="sort-button" data-sort="rating">í‰ì  ìˆœ</button>
        <button class="sort-button" data-sort="value">ê°€ì„±ë¹„ ìˆœ</button>
        <button class="filter-chip" data-filter="korean">í•œì‹</button>
        <button class="filter-chip" data-filter="chinese">ì¤‘ì‹</button>
        <button class="filter-chip" data-filter="western">ì–‘ì‹</button>
        <button class="filter-chip" data-filter="no-wait">ëŒ€ê¸°ì—†ìŒ</button>
        <button class="filter-chip" data-filter="affordable">ì €ë ´í•œ</button>
    </div>

    <!-- ê²°ê³¼ ì»¨í…Œì´ë„ˆ -->
    <div class="results-container">
        <!-- ë¦¬ìŠ¤íŠ¸ ë·° -->
        <div class="restaurant-list" id="restaurantList">
            <!-- ë¡œë”© ì•„ì´í…œë“¤ -->
            <div class="loading-item">
                <div class="loading-content">
                    <div class="loading-image skeleton"></div>
                    <div class="loading-details">
                        <div class="loading-line skeleton"></div>
                        <div class="loading-line skeleton short"></div>
                        <div class="loading-line skeleton medium"></div>
                    </div>
                </div>
            </div>
            <div class="loading-item">
                <div class="loading-content">
                    <div class="loading-image skeleton"></div>
                    <div class="loading-details">
                        <div class="loading-line skeleton"></div>
                        <div class="loading-line skeleton short"></div>
                        <div class="loading-line skeleton medium"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì§€ë„ ë·° (ì¶”í›„ êµ¬í˜„) -->
        <div class="map-view" id="mapView">
            <div>ì§€ë„ ë·°ëŠ” ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤</div>
        </div>
    </div>

    <!-- ë·° ì „í™˜ ë²„íŠ¼ -->
    <button class="view-toggle" onclick="toggleView()">ğŸ—ºï¸</button>

    <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="bottom-nav">
        <div class="bottom-nav-content">
            <a href="#" class="bottom-nav-item" onclick="Utils.navigateTo('01-í™ˆí™”ë©´')">
                <div class="bottom-nav-icon">ğŸ </div>
                <div class="bottom-nav-label">í™ˆ</div>
            </a>
            <a href="#" class="bottom-nav-item active">
                <div class="bottom-nav-icon">ğŸ”</div>
                <div class="bottom-nav-label">ê²€ìƒ‰</div>
            </a>
            <a href="#" class="bottom-nav-item" onclick="Utils.navigateTo('06-ì£¼ë¬¸ìƒíƒœ')">
                <div class="bottom-nav-icon">ğŸ½ï¸</div>
                <div class="bottom-nav-label">ì£¼ë¬¸</div>
            </a>
            <a href="#" class="bottom-nav-item" onclick="Utils.navigateTo('09-ê°œì¸ë¶„ì„')">
                <div class="bottom-nav-icon">ğŸ‘¤</div>
                <div class="bottom-nav-label">ë‚´ ì •ë³´</div>
            </a>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        let currentSort = 'distance';
        let activeFilters = new Set();
        let allRestaurants = [];
        let currentView = 'list'; // 'list' or 'map'

        // í˜ì´ì§€ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async () => {
            await initializePage();
        });

        async function initializePage() {
            try {
                // ì„¸ì…˜ì—ì„œ ê²€ìƒ‰ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const searchQuery = Utils.session.get('searchQuery') || '';
                const searchRadius = Utils.session.get('searchRadius') || 500;

                // ê²€ìƒ‰ì°½ì— ì¿¼ë¦¬ ì„¤ì •
                document.getElementById('searchInput').value = searchQuery;

                // ê²€ìƒ‰ ìˆ˜í–‰
                await performSearch(searchQuery, searchRadius);

            } catch (error) {
                console.error('í˜ì´ì§€ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                showNoResults('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ê²€ìƒ‰ ìˆ˜í–‰
        async function performSearch(query = '', radius = 500) {
            try {
                const results = await DataService.searchRestaurants(query, AppState.currentLocation, radius);
                allRestaurants = results;

                updateResultCount(results.length, query);
                displayResults(results);

            } catch (error) {
                console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                showNoResults('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ê²°ê³¼ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
        function updateResultCount(count, query) {
            const resultCountEl = document.getElementById('resultCount');

            if (query) {
                resultCountEl.textContent = `'${query}' ê²€ìƒ‰ê²°ê³¼ ${count}ê°œ`;
            } else {
                resultCountEl.textContent = `ì£¼ë³€ ë§›ì§‘ ${count}ê°œ`;
            }
        }

        // ê²°ê³¼ í‘œì‹œ
        function displayResults(restaurants) {
            const listContainer = document.getElementById('restaurantList');

            if (restaurants.length === 0) {
                showNoResults();
                return;
            }

            listContainer.innerHTML = restaurants.map(restaurant => createRestaurantItem(restaurant)).join('');

            // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            listContainer.querySelectorAll('.restaurant-item').forEach((item, index) => {
                item.addEventListener('click', () => {
                    AppState.selectedRestaurant = restaurants[index];
                    Utils.session.set('selectedRestaurant', restaurants[index]);
                    Utils.navigateTo('03-ì‹ë‹¹ìƒì„¸');
                });
            });
        }

        // ì‹ë‹¹ ì•„ì´í…œ ìƒì„±
        function createRestaurantItem(restaurant) {
            const waitTimeClass = Utils.getWaitTimeClass(restaurant.waitTime);
            const valueScoreClass = Utils.getValueScoreClass(restaurant.valueScore);

            return `
                <div class="restaurant-item touchable" data-restaurant-id="${restaurant.id}">
                    <div class="restaurant-content">
                        <img src="${restaurant.image}" alt="${restaurant.name}" class="restaurant-image">
                        <div class="restaurant-details">
                            <div class="restaurant-header">
                                <div class="restaurant-title">
                                    <div class="restaurant-name">${restaurant.name}</div>
                                    <div class="restaurant-category">${restaurant.category}</div>
                                </div>
                                <div class="value-score ${valueScoreClass}">${restaurant.valueScore.toFixed(1)}</div>
                            </div>

                            <div class="restaurant-metrics">
                                <div class="metrics-row">
                                    <div class="rating">
                                        <span class="rating-star filled">â˜…</span>
                                        <span class="rating-score">${restaurant.rating.toFixed(1)}</span>
                                        <span class="rating-count">(${restaurant.reviewCount})</span>
                                    </div>
                                    <div class="wait-time ${waitTimeClass}">
                                        ${restaurant.waitTime === 0 ? 'ëŒ€ê¸°ì—†ìŒ' : restaurant.waitTime + 'ë¶„ ëŒ€ê¸°'}
                                    </div>
                                </div>

                                <div class="metrics-row">
                                    <div class="distance-info">${Utils.formatDistance(restaurant.distance)}</div>
                                    <div class="price-info">
                                        <span class="price-symbol ${restaurant.priceRange}"></span>
                                        í‰ê·  ${Utils.formatPrice(restaurant.averagePrice)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ê²°ê³¼ ì—†ìŒ í‘œì‹œ
        function showNoResults(message = '') {
            const listContainer = document.getElementById('restaurantList');

            listContainer.innerHTML = `
                <div class="no-results">
                    <div class="no-results-icon">ğŸ˜”</div>
                    <div class="no-results-text">${message || 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤'}</div>
                    <div class="no-results-suggestion">ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”</div>
                </div>
            `;
        }

        // ê²€ìƒ‰ì–´ ì§€ìš°ê¸°
        function clearSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.value = '';
            searchInput.focus();
        }

        // ë·° ì „í™˜
        function toggleView() {
            const listView = document.getElementById('restaurantList');
            const mapView = document.getElementById('mapView');
            const toggleButton = document.querySelector('.view-toggle');

            if (currentView === 'list') {
                currentView = 'map';
                listView.style.display = 'none';
                mapView.style.display = 'flex';
                toggleButton.textContent = 'ğŸ“‹';
            } else {
                currentView = 'list';
                listView.style.display = 'flex';
                mapView.style.display = 'none';
                toggleButton.textContent = 'ğŸ—ºï¸';
            }
        }

        // ì •ë ¬ ë° í•„í„° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.querySelectorAll('.sort-button').forEach(button => {
            button.addEventListener('click', () => {
                // í™œì„± ìƒíƒœ ë³€ê²½
                document.querySelectorAll('.sort-button').forEach(b => b.classList.remove('active'));
                button.classList.add('active');

                currentSort = button.dataset.sort;
                applySortAndFilters();
            });
        });

        document.querySelectorAll('.filter-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                const filter = chip.dataset.filter;

                if (activeFilters.has(filter)) {
                    activeFilters.delete(filter);
                    chip.classList.remove('active');
                } else {
                    activeFilters.add(filter);
                    chip.classList.add('active');
                }

                applySortAndFilters();
            });
        });

        // ì •ë ¬ ë° í•„í„° ì ìš©
        function applySortAndFilters() {
            let filteredRestaurants = [...allRestaurants];

            // í•„í„° ì ìš©
            if (activeFilters.size > 0) {
                filteredRestaurants = filteredRestaurants.filter(restaurant => {
                    for (let filter of activeFilters) {
                        switch (filter) {
                            case 'korean':
                                if (restaurant.category !== 'í•œì‹') return false;
                                break;
                            case 'chinese':
                                if (restaurant.category !== 'ì¤‘ì‹') return false;
                                break;
                            case 'western':
                                if (restaurant.category !== 'ì–‘ì‹') return false;
                                break;
                            case 'no-wait':
                                if (restaurant.waitTime > 0) return false;
                                break;
                            case 'affordable':
                                if (restaurant.priceRange !== 'affordable') return false;
                                break;
                        }
                    }
                    return true;
                });
            }

            // ì •ë ¬ ì ìš©
            switch (currentSort) {
                case 'distance':
                    filteredRestaurants.sort((a, b) => a.distance - b.distance);
                    break;
                case 'rating':
                    filteredRestaurants.sort((a, b) => b.rating - a.rating);
                    break;
                case 'value':
                    filteredRestaurants.sort((a, b) => b.valueScore - a.valueScore);
                    break;
            }

            updateResultCount(filteredRestaurants.length, document.getElementById('searchInput').value);
            displayResults(filteredRestaurants);
        }

        // ê²€ìƒ‰ì°½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const query = e.target.value.trim();
                performSearch(query, 500);
            }
        });

        // ì‹¤ì‹œê°„ ê²€ìƒ‰ (ë””ë°”ìš´ìŠ¤)
        const debouncedSearch = Utils.debounce((query) => {
            if (query.length >= 2 || query.length === 0) {
                performSearch(query, 500);
            }
        }, 500);

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.trim();
            debouncedSearch(query);
        });
    </script>
</body>
</html>